'use strict';

var usernamePage = document.querySelector('#username-page');
var chatPage = document.querySelector('#chat-page');
var usernameForm = document.querySelector('#usernameForm');
var messageForm = document.querySelector('#messageForm');
var messageInput = document.querySelector('#message');
var messageArea = document.querySelector('#messageArea');
var connectingElement = document.querySelector('.connecting');

var stompClient = null;
var username = null;
var room = null;

var colors = [
    '#2196F3', '#32c787', '#00BCD4', '#ff5652',
    '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
];

const subscribedRooms = new Set();

function subscribeRoom(room) {
    if (subscribedRooms.has(room)) return; // al gedaan
    subscribedRooms.add(room);

    stompClient.subscribe(`/topic/room.${room}`, function(payload) {
        displayMessage(JSON.parse(payload.body));
    });
}

// =========================
// Connect functie
// =========================
function connect() {
    if (stompClient && stompClient.connected) return; // voorkom dubbele connect

    username = document.querySelector('#name')?.value.trim() || 'Anonymous';
    room = document.querySelector('#room')?.value.trim() || room || "general";

    if (username && room) {
        usernamePage.classList.add('hidden');
        chatPage.classList.remove('hidden');

        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            onConnected();
        }, onError);
    }
}

// =========================
// Bij connect
// =========================
function onConnected() {
    //console.log("!@#$ ALLERBEGIN van function onConnected() {");

    if (!stompClient || !stompClient.connected) return;
    //console.log("NA if (!stompClient || !stompClient.connected) return;");

    // 1️⃣ Subscribe naar live berichten van de huidige room
    subscribeRoom(room);

    // 2️⃣ Subscribe naar de queue voor historische berichten
    stompClient.subscribe(`/user/queue/history`, function(payload) {
        //console.log("!@#$ HISTORIE ontvangen"); 

        var data = JSON.parse(payload.body);

        // check of het een array is (option-2 server-side)
        if (Array.isArray(data)) {
            data.forEach(msg => displayMessage(msg, true));
        } else {
            displayMessage(data, true);
        }

        //console.log(">>>>!@#$ HISTORIE data:", data);
    });

    // 3️⃣ Historische berichten expliciet ophalen na subscriptions
    stompClient.send("/app/chat.loadHistory",
        {},
        JSON.stringify({sender: username, room: room})
    );

    // 4️⃣ JOIN event pas daarna
    stompClient.send("/app/chat.addUser",
        {},
        JSON.stringify({sender: username, type: 'JOIN', room: room})
    );

    // 5️⃣ Nu connecting-element verbergen
    connectingElement.classList.add('hidden');

    //console.log("!@#$ EINDE onConnected()");
}

// =========================
// Foutafhandeling
// =========================
function onError(error) {
    connectingElement.textContent = 'Could not connect to WebSocket server. Please refresh this page to try again!';
    connectingElement.style.color = 'red';
}

// =========================
// Verstuur bericht
// =========================
function sendMessage(event) {
    var messageContent = messageInput.value.trim();
    if (messageContent && stompClient) {
        var chatMessage = {
            sender: username,
            content: messageContent,
            type: 'CHAT',
            room: room
        };
        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        messageInput.value = '';
    }
    event.preventDefault();
}

// =========================
// Display message helper
// =========================
function displayMessage(message, isHistory = false) {
    var messageElement = document.createElement('li');

    if (isHistory) {
        // Voeg aparte CSS-klasse toe
        messageElement.classList.add('history-message');

        // Datum/tijd formatteren
        var timestamp = message.timestamp ? new Date(message.timestamp) : new Date();
        var hh = String(timestamp.getHours()).padStart(2, '0');
        var mm = String(timestamp.getMinutes()).padStart(2, '0');
        var yyyy = timestamp.getFullYear();
        var mmth = String(timestamp.getMonth() + 1).padStart(2, '0');
        var dd = String(timestamp.getDate()).padStart(2, '0');
        var dateStr = `${yyyy}${mmth}${dd} ${hh}:${mm}`;

        // Initiaal van afzender
        var senderInitial = message.sender ? message.sender[0] : '?';
        messageElement.textContent = `${dateStr}, ${senderInitial}: ${message.content}`;

        // Historische berichten bovenaan toevoegen
        messageArea.prepend(messageElement);

    } else {
        // Live berichten blijven zoals voorheen
        if (message.type === 'JOIN') {
            messageElement.classList.add('event-message');
            message.content = message.sender + ' joined!';
        } else if (message.type === 'LEAVE') {
            messageElement.classList.add('event-message');
            message.content = message.sender + ' left!';
        } else {
            messageElement.classList.add('chat-message');

            var avatarElement = document.createElement('i');
            avatarElement.textContent = message.sender[0];
            avatarElement.style['background-color'] = getAvatarColor(message.sender);
            messageElement.appendChild(avatarElement);

            var usernameElement = document.createElement('span');
            usernameElement.textContent = message.sender;
            messageElement.appendChild(usernameElement);
        }

        var textElement = document.createElement('p');
        textElement.textContent = message.content;
        messageElement.appendChild(textElement);

        messageArea.appendChild(messageElement);
    }

    // Scroll altijd naar onder
    messageArea.scrollTop = messageArea.scrollHeight;
}

// =========================
// Avatar kleur
// =========================
function getAvatarColor(messageSender) {
    var hash = 0;
    for (var i = 0; i < messageSender.length; i++) {
        hash = 31 * hash + messageSender.charCodeAt(i);
    }
    return colors[Math.abs(hash % colors.length)];
}

// =========================
// Event listeners
// =========================

// Form submit vrije input
if (usernameForm) {
    usernameForm.addEventListener('submit', function(event){
        connect();
        event.preventDefault();
    }, true);
}

// Versturen van chatbericht
if (messageForm) {
    messageForm.addEventListener('submit', sendMessage, true);
}

// =========================
// Predefined-room buttons
// =========================
document.querySelectorAll('.predefined-rooms button').forEach(button => {
    button.addEventListener('click', function() {
        let newRoom = button.getAttribute('data-room');
        if (!newRoom) return;

        // Unsubscribe van oude room (indien mogelijk)
        // stompClient.unsubscribe(subscriptionId); // optioneel als je een ID bewaart

        room = newRoom;

        if (!stompClient || !stompClient.connected) {
            connect();
        } else {
            // Alleen JOIN en loadHistory sturen, niet extra subscribe
            stompClient.send("/app/chat.addUser",
                {},
                JSON.stringify({sender: username, type: 'JOIN', room: room})
            );
            stompClient.send("/app/chat.loadHistory",
                {},
                JSON.stringify({sender: username, room: room})
            );
        }
    });
});
